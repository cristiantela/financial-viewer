<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Financial Viewer</title>
    <script src="vue/vue.js"></script>
    <link rel="stylesheet" href="bootstrap/bootstrap.min.css" />
  </head>

  <body>
    <div id="app">
      <div class="container">
        <div class="row">
          <div class="col">
            Input

            <textarea
              v-model="input"
              rows="10"
              class="form-control form-control-sm mb-1"
            ></textarea>

            <button @click="save" class="btn btn-sm btn-primary">
              Save Local
              <span v-if="unsavedInput">*</span>
            </button>
          </div>
        </div>

        <div class="row">
          <div v-for="block in dataReverse" class="col-12">
            <h1 class="text-center">
              {{ monthName(block.month) }}/{{ block.year }}
            </h1>

            <div class="row">
              <div class="col-12 col-sm-6">
                <div v-for="(payment, paymentIndex) in block.payments" :key="paymentIndex">
                  <div v-if="payment.isEditing" class="row">
                    <div class="col-3">
                      <input v-model="payment.value" :ref="`${block.month}-${block.year}-${paymentIndex}-value`" @blur="payment.isEditing = false" type="number" class="form-control form-control-sm text-right">
                    </div>

                    <div class="col">
                      <input v-model="payment.description" :ref="`${block.month}-${block.year}-${paymentIndex}-description`" @blur="payment.isEditing = false" type="text" class="form-control form-control-sm">
                    </div>
                  </div>

                  <div v-else class="row">
                    <div @click="edit(block, paymentIndex, 'value')" class="col-3 text-right">{{ payment.value }}</div>

                    <div class="col">
                      <span
                        v-if="payment.receivedOn"
                        class="badge badge-info mr-1"
                      >
                        Received on {{ payment.receivedOn }}
                      </span>

                      <span
                        v-if="payment.payedOn"
                        class="badge badge-success mr-1"
                      >
                        Payed on {{ payment.payedOn }}
                      </span>
                      <span
                        v-for="tag in payment.tags"
                        class="badge badge-primary mr-1"
                      >
                        {{ tag }}
                      </span>

                      <span @click="edit(block, paymentIndex, 'description')">{{ upperCaseFirstLetter(payment.description) }}</span>
                    </div>
                  </div>
                </div>

                <div class="row">
                  <div class="col-3 text-right">
                    {{ sumArray(block.payments.map(payment =>
                    Number(payment.value) || 0)).toFixed(2) }}
                  </div>
                </div>

                <div class="row">
                  <div class="col offset-3">
                    <button @click="addPayment(block)" :disabled="unsavedInput" class="btn btn-sm btn-primary">Add Payment</button>
                  </div>
                </div>
              </div>

              <div class="col-12 col-sm-6">
                <div class="row mb-4">
                  <div class="col">
                    <div class="row">
                      <div class="col text-right">
                        Revenue {{ revenue(block.payments).toFixed(2) }}
                      </div>
                    </div>

                    <div>
                      <div
                        v-for="color in colors"
                        :style="{
                      width: color.width + '%',
                      height: '.5em',
                      backgroundColor: color.color,
                      display: 'inline-block'
                    }"
                      ></div>
                    </div>

                    <div>
                      <div
                        v-for="tag in groupTags(block.payments)"
                        :style="{
                      width: tag.percentage + '%',
                      height: '1em',
                      backgroundColor: tag.color,
                      display: 'inline-block'
                    }"
                      ></div>
                      {{ (spent(block.payments) / revenue(block.payments) *
                      100).toFixed(1) }}%
                    </div>

                    <div class="row">
                      <div class="col text-right">
                        <div
                          :style="{
                          width: spent(block.payments) / revenue(block.payments) * 100 + '%',
                        }"
                        >
                          Spent {{ spent(block.payments).toFixed(2) }}
                          <br />
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div v-for="tag in groupTags(block.payments)" class="row">
                  <div class="col-2 text-right">{{ tag.value.toFixed(2) }}</div>
                  <div class="col-3 text-right">
                    {{ tag.name }}
                  </div>
                  <div class="col">
                    <div
                      :style="{
                      width: tag.percentage + '%',
                      height: '1em',
                      backgroundColor: tag.color,
                      display: 'inline-block'
                    }"
                    ></div>
                    {{ tag.percentage.toFixed(1) }}%
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      new Vue({
        el: "#app",
        data: {
          savedInput: "",
          input: "",
          data: [],
          colors: [
            {
              width: 60,
              color: "#2ecc71"
            },
            {
              width: 10,
              color: "#f39c12"
            },
            {
              width: 30,
              color: "#e74c3c"
            }
          ]
        },

        created() {
          this.getSavedInput();
        },

        methods: {
          monthName(month) {
            return "January,February,March,April,May,June,July,August,September,November,December".split(
              ","
            )[month - 1];
          },

          sumArray(array) {
            if (array.length === 0) {
              return 0;
            } else if (array.length === 1) {
              return array[0];
            }

            return array.reduce((value, current) => value + current);
          },

          upperCaseFirstLetter(text) {
            return text.slice(0, 1).toUpperCase() + text.slice(1);
          },

          getSavedInput() {
            let financialViewerContent = localStorage.getItem(
              "financial-viewer"
            );

            if (financialViewerContent === null) {
              this.savedInput = `
03/2020
1000 salary
-70 payed on 11 dentist plan #health
-50 bus credit #transport #bus

04/2020
1000 salary
                                  `;
            } else {
              this.savedInput = financialViewerContent;
            }

            this.input = this.savedInput;
          },

          save() {
            localStorage.setItem("financial-viewer", this.input);
            this.savedInput = this.input;
          },

          revenue(payments) {
            return this.sumArray(
              payments.map(payment => Number(payment.value) || 0).filter(value => value > 0)
            );
          },

          spent(payments) {
            return -this.sumArray(
              payments.map(payment => payment.value).filter(value => value < 0)
            );
          },

          groupTags(payments) {
            const revenue = this.revenue(payments);

            const tags = [
              {
                name: "others",
                value: 0
              }
            ];

            payments
              .filter(payment => payment.value < 0)
              .forEach(payment => {
                if (payment.tags.length === 0) {
                  tags.find(
                    tag => tag.name === "others"
                  ).value += -payment.value;
                } else {
                  payment.tags.forEach(tag => {
                    const tagDivisions = tag.split("/");
                    const tagName = tagDivisions[0];

                    const t = tags.find(t => t.name === tagName);

                    if (t) {
                      t.value += -payment.value;
                    } else {
                      tags.push({
                        name: tagName,
                        value: -payment.value
                      });
                    }
                  });
                }
              });

            tags.sort((a, b) => {
              if (a.value > b.value) {
                return -1;
              } else if (a.value < b.value) {
                return 1;
              }

              return 0;
            });

            const colors = [
              "#9b59b6",
              "#2980b9",
              "#27ae60",
              "#16a085",
              "#2c3e50",
              "#f1c40f",
              "#c0392b",
              "#e67e22",
              "#2ecc71",
              "#f39c12"
            ];

            let counter = 0;

            tags.forEach(tag => {
              tag.percentage = (tag.value / revenue) * 100;
              tag.color = colors[counter++ % colors.length];
            });

            return tags.filter(
              tag => !(tag.name === "others" && tag.value === 0)
            );
          },

          addPayment(block) {
            block.payments.push({
              value: 0,
              description: '',
              payedOn: '',
              receivedOn: '',
              tags: [],
              isEditing: true,
            });

            this.$nextTick(() => {
              this.$refs[`${block.month}-${block.year}-${block.payments.length - 1}-description`][0].focus();
            });
          },

          edit(block, paymentIndex, attribute) {
            if (this.unsavedInput) {
              return false;
            }

            block.payments[paymentIndex].isEditing = true;

            this.$nextTick(() => {
              this.$refs[`${block.month}-${block.year}-${paymentIndex}-${attribute}`][0].focus();
            });
          },
        },

        computed: {
          dataReverse() {
            return this.data.reverse();
          },

          unsavedInput() {
            return this.savedInput !== this.input;
          },
        },

        watch: {
          input: {
            handler(input) {
              this.data = [];

              let currentBlock = null;

              input.split("\n").forEach(line => {
                const rules = {
                  blockStart: /^(\d{2})\/(\d{4})$/,
                  payment: /^(-?[\d.]+) /,
                  actionOn: /^(payed|received) on (\d{2}) ?/,
                  tags: /#([^#]+)/
                };

                if (rules.blockStart.test(line)) {
                  const infos = line.match(rules.blockStart);

                  currentBlock = {
                    month: infos[1],
                    year: infos[2],
                    payments: []
                  };

                  this.data.push(currentBlock);
                } else if (rules.payment.test(line)) {
                  const infos = line.match(rules.payment);

                  let text = line.slice(infos[0].length);

                  let payedOn = null,
                    receivedOn = null,
                    tags = [];

                  while (rules.actionOn.test(text)) {
                    let matches = text.match(rules.actionOn);
                    let action = matches[1];

                    if (action === "payed") {
                      payedOn = matches[2];
                    } else if (action === "received") {
                      receivedOn = matches[2];
                    }

                    text = text.slice(matches[0].length);
                  }

                  while (rules.tags.test(text)) {
                    let matches = text.match(rules.tags);

                    text =
                      text.slice(0, matches.index) +
                      text.slice(matches.index + matches[0].length);

                    tags.push(matches[1].trim());
                  }

                  currentBlock.payments.push({
                    value: Number(infos[1]),
                    description: text.trim(),
                    payedOn: payedOn,
                    receivedOn: receivedOn,
                    tags: tags,
                    isEditing: false,
                  });
                }
              });
            },
            immediate: true
          }
        }
      });
    </script>
  </body>
</html>
